/*
https://leetcode.com/problems/countries-you-can-safely-invest-in/

1501. Countries You Can Safely Invest In

CREATE TABLE CALLS (
caller_id number(4),
callee_id number(4),
duration number(5)
);

INSERT INTO CALLS VALUES (1,9,33);
INSERT INTO CALLS VALUES (2,9,4);
INSERT INTO CALLS VALUES (1,2,59);
INSERT INTO CALLS VALUES (3,12,102);
INSERT INTO CALLS VALUES (3,12,330);
INSERT INTO CALLS VALUES (12,3,5);
INSERT INTO CALLS VALUES (7,9,13);
INSERT INTO CALLS VALUES (7,1,3);
INSERT INTO CALLS VALUES (9,7,1);
INSERT INTO CALLS VALUES (1,7,7);


CREATE TABLE COUNTRY (
name varchar2(20),
country_code number(5)
);

INSERT INTO COUNTRY VALUES ('Peru',051);
INSERT INTO COUNTRY VALUES ('Israel',972);
INSERT INTO COUNTRY VALUES ('Morocco',212);
INSERT INTO COUNTRY VALUES ('Germany',049);
INSERT INTO COUNTRY VALUES ('Ethiopia',251);


CREATE TABLE Person (
id number(3),
name varchar2(20),
phone_number varchar2(20)
);

INSERT INTO PERSON VALUES (3,'Jonathan','051-1234567');
INSERT INTO PERSON VALUES (12,'Elvis','051-7654321');
INSERT INTO PERSON VALUES (1,'Moncef','212-1234567');
INSERT INTO PERSON VALUES (2,'Moroua','212-6523651');
INSERT INTO PERSON VALUES (7,'Meir','972-1234567');
INSERT INTO PERSON VALUES (9,'Rachel','972-0011100');

{"headers":{"Person":["id","name","phone_number"],"Country":["name","country_code"],"Calls":["caller_id","callee_id","duration"]},"rows":{"Person":[[989,"Naftali","523-7847696"],[422,"Tamar","670-0840142"],[123,"Yosef","728-6529775"],[460,"Yaakov","515-4655306"],[285,"Tamar","119-4963054"],[546,"Menachem","550-5622421"],[407,"Yaakov","584-0211700"],[824,"Tikvah","119-4931906"],[320,"Tamar","089-2960728"],[107,"Sarah","089-4128482"],[765,"Freida","646-1074145"],[13,"Rachel","187-6516857"],[935,"Adam","550-0464730"],[792,"Yaffah","202-2765764"],[343,"Sarah","119-8935789"],[933,"Yosef","285-7578157"],[263,"Dalia","584-9041687"],[464,"Moshe","285-7682744"],[748,"Menachem","174-4162360"],[762,"Daniel","623-4209590"]],"Country":[["Libya","119"],["Nigeria","728"],["Japan","187"],["SaudiArabia","523"],["Qatar","089"],["Israel","670"],["France","409"],["Turkey","584"],["Mexico","918"],["China","646"],["Ethiopia","285"],["Algeria","034"],["Spain","549"],["Tunisia","488"],["Morocco","550"],["Germany","202"],["Italy","623"],["Brazil","515"],["Peru","526"],["Russia","174"]],"Calls":[[285,824,674],[792,422,512],[13,546,296],[422,464,394],[762,422,139],[460,935,462],[343,460,145],[263,464,462],[792,320,913],[765,762,391],[422,123,863],[320,546,175],[123,407,979],[765,935,54],[460,107,93],[460,422,606],[748,762,269],[285,989,421],[343,765,528],[933,824,644],[285,748,569],[935,748,363],[464,762,447],[13,765,907],[935,422,311],[285,13,68],[407,824,130],[263,407,593],[824,263,371],[460,935,158],[123,263,367],[123,464,973],[989,407,875],[792,989,256],[460,263,457],[546,123,48],[935,933,732],[107,989,499],[422,765,646],[765,263,201]]}}
TEST CASE:

INSERT INTO PERSON VALUES (989,'Naftali','523-7847696');
INSERT INTO PERSON VALUES (422,'Tamar','670-0840142');
INSERT INTO PERSON VALUES (123,'Yosef','728-6529775');
INSERT INTO PERSON VALUES (460,'Yaakov','515-4655306');
INSERT INTO PERSON VALUES (285,'Tamar','119-4963054');
INSERT INTO PERSON VALUES (546,'Menachem','550-5622421');
INSERT INTO PERSON VALUES (407,'Yaakov','584-0211700');
INSERT INTO PERSON VALUES (824,'Tikvah','119-4931906');
INSERT INTO PERSON VALUES (320,'Tamar','089-2960728');
INSERT INTO PERSON VALUES (107,'Sarah','089-4128482');
INSERT INTO PERSON VALUES (765,'Freida','646-1074145');
INSERT INTO PERSON VALUES (13,'Rachel','187-6516857');
INSERT INTO PERSON VALUES (935,'Adam','550-0464730');
INSERT INTO PERSON VALUES (792,'Yaffah','202-2765764');
INSERT INTO PERSON VALUES (343,'Sarah','119-8935789');
INSERT INTO PERSON VALUES (933,'Yosef','285-7578157');
INSERT INTO PERSON VALUES (263,'Dalia','584-9041687');
INSERT INTO PERSON VALUES (464,'Moshe','285-7682744');
INSERT INTO PERSON VALUES (748,'Menachem','174-4162360');
INSERT INTO PERSON VALUES (762,'Daniel','623-4209590');



INSERT INTO COUNTRY VALUES ('Libya','119');
INSERT INTO COUNTRY VALUES ('Nigeria','728');
INSERT INTO COUNTRY VALUES ('Japan','187');
INSERT INTO COUNTRY VALUES ('SaudiArabia','523');
INSERT INTO COUNTRY VALUES ('Qatar','089');
INSERT INTO COUNTRY VALUES ('Israel','670');
INSERT INTO COUNTRY VALUES ('France','409');
INSERT INTO COUNTRY VALUES ('Turkey','584');
INSERT INTO COUNTRY VALUES ('Mexico','918');
INSERT INTO COUNTRY VALUES ('China','646');
INSERT INTO COUNTRY VALUES ('Ethiopia','285');
INSERT INTO COUNTRY VALUES ('Algeria','034');
INSERT INTO COUNTRY VALUES ('Spain','549');
INSERT INTO COUNTRY VALUES ('Tunisia','488');
INSERT INTO COUNTRY VALUES ('Morocco','550');
INSERT INTO COUNTRY VALUES ('Germany','202');
INSERT INTO COUNTRY VALUES ('Italy','623');
INSERT INTO COUNTRY VALUES ('Brazil','515');
INSERT INTO COUNTRY VALUES ('Peru','526');
INSERT INTO COUNTRY VALUES ('Russia','174');


INSERT INTO CALLS VALUES (285,824,674);
INSERT INTO CALLS VALUES (792,422,512);
INSERT INTO CALLS VALUES (13,546,296);
INSERT INTO CALLS VALUES (422,464,394);
INSERT INTO CALLS VALUES (762,422,139);
INSERT INTO CALLS VALUES (460,935,462);
INSERT INTO CALLS VALUES (343,460,145);
INSERT INTO CALLS VALUES (263,464,462);
INSERT INTO CALLS VALUES (792,320,913);
INSERT INTO CALLS VALUES (765,762,391);
INSERT INTO CALLS VALUES (422,123,863);
INSERT INTO CALLS VALUES (320,546,175);
INSERT INTO CALLS VALUES (123,407,979);
INSERT INTO CALLS VALUES (765,935,54);
INSERT INTO CALLS VALUES (460,107,93);
INSERT INTO CALLS VALUES (460,422,606);
INSERT INTO CALLS VALUES (748,762,269);
INSERT INTO CALLS VALUES (285,989,421);
INSERT INTO CALLS VALUES (343,765,528);
INSERT INTO CALLS VALUES (933,824,644);
INSERT INTO CALLS VALUES (285,748,569);
INSERT INTO CALLS VALUES (935,748,363);
INSERT INTO CALLS VALUES (464,762,447);
INSERT INTO CALLS VALUES (13,765,907);
INSERT INTO CALLS VALUES (935,422,311);
INSERT INTO CALLS VALUES (285,13,68);
INSERT INTO CALLS VALUES (407,824,130);
INSERT INTO CALLS VALUES (263,407,593);
INSERT INTO CALLS VALUES (824,263,371);
INSERT INTO CALLS VALUES (460,935,158);
INSERT INTO CALLS VALUES (123,263,367);
INSERT INTO CALLS VALUES (123,464,973);
INSERT INTO CALLS VALUES (989,407,875);
INSERT INTO CALLS VALUES (792,989,256);
INSERT INTO CALLS VALUES (460,263,457);
INSERT INTO CALLS VALUES (546,123,48);
INSERT INTO CALLS VALUES (935,933,732);
INSERT INTO CALLS VALUES (107,989,499);
INSERT INTO CALLS VALUES (422,765,646);
INSERT INTO CALLS VALUES (765,263,201);






*/


SELECT COUNTRY FROM 
(SELECT CALLER_COUNTRY AS COUNTRY, ROUND(AVG(DURATION),2) AS AVG_TIME
FROM 
(
SELECT caller_id, duration, A.name as caller_name, A.phone_number as Caller_phone, B.name as caller_country 
from Calls T
LEFT JOIN Person A
ON T.caller_id = A.id
LEFT JOIN Country B
ON substr(trim(A.phone_number),1,3) = B.country_code

UNION

SELECT callee_id, duration, A.name as caller_name, A.phone_number as Caller_phone, B.name as caller_country 
from Calls T
LEFT JOIN Person A
ON T.callee_id = A.id
LEFT JOIN Country B
ON substr(trim(A.phone_number),1,3) = B.country_code
)temp
GROUP BY CALLER_COUNTRY
ORDER BY 2 DESC
)X
WHERE AVG_TIME >= (SELECT ROUND((2*SUM(DURATION))/20,2) FROM CALLS)